name: Sync Ski Area Data

on:
  # Run weekly on Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'

  workflow_dispatch:
    inputs:
      country:
        description: 'Country code (e.g., FR, CH, AT) or "all" for all countries'
        required: true
        default: 'all'
      skip_runs:
        description: 'Skip syncing runs (faster for testing)'
        type: boolean
        default: false
      skip_lifts:
        description: 'Skip syncing lifts (faster for testing)'
        type: boolean
        default: false
      skip_connections:
        description: 'Skip detecting ski area connections'
        type: boolean
        default: false

  # Can be called from other workflows
  workflow_call:
    inputs:
      country:
        type: string
        required: true
      skip_runs:
        type: boolean
        default: false
      skip_lifts:
        type: boolean
        default: false
      skip_connections:
        type: boolean
        default: false
    secrets:
      DATABASE_URL:
        required: true

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  # Download all geojson data once, then share with parallel country jobs
  download-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Download OpenSkiMap geojson files
        run: |
          echo "ðŸ“¥ Downloading OpenSkiMap geojson files..."
          mkdir -p openskimap-data

          # Download all three files with retry logic
          for file in ski_areas.geojson runs.geojson lifts.geojson; do
            echo "Downloading $file..."
            curl -s --retry 5 --retry-delay 10 --connect-timeout 30 --max-time 600 \
              "https://tiles.openskimap.org/geojson/$file" \
              -o "openskimap-data/$file"

            # Verify download
            size=$(stat -c%s "openskimap-data/$file")
            echo "  Downloaded $file ($(numfmt --to=iec-i --suffix=B $size))"

            if [ "$size" -lt 1000 ]; then
              echo "âŒ Error: $file is too small, download may have failed"
              exit 1
            fi
          done

          echo "âœ… All files downloaded successfully"

      - name: Upload geojson data as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openskimap-data
          path: openskimap-data/
          retention-days: 1

  sync-country:
    runs-on: ubuntu-latest
    needs: download-data
    timeout-minutes: 120

    strategy:
      matrix:
        # For scheduled runs or 'all', run for all countries; otherwise just the specified one
        country: ${{ (github.event_name == 'schedule' || inputs.country == 'all') && fromJson('["FR", "CH", "AT", "IT", "DE", "US", "CA", "NZ", "JP", "AU", "NO", "SE", "FI", "ES", "AD", "BG", "RO", "SI", "SK", "PL", "CZ"]') || fromJson(format('["{0}"]', inputs.country)) }}
      fail-fast: false
      max-parallel: 10  # Run countries in parallel
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Download geojson data artifact
        uses: actions/download-artifact@v4
        with:
          name: openskimap-data
          path: openskimap-data

      - name: Sync ski area data for ${{ matrix.country }}
        run: |
          echo "ðŸŽ¿ Syncing ski area data for ${{ matrix.country }}..."

          # Build command with optional flags and data directory
          CMD="npx tsx scripts/sync-data.ts --country=${{ matrix.country }} --data-dir=openskimap-data"
          
          if [ "${{ inputs.skip_runs }}" = "true" ]; then
            CMD="$CMD --skip-runs"
          fi
          
          if [ "${{ inputs.skip_lifts }}" = "true" ]; then
            CMD="$CMD --skip-lifts"
          fi
          
          # Run with retry logic
          MAX_RETRIES=3
          RETRY_DELAY=60
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."
            if $CMD; then
              echo "âœ… Successfully synced ${{ matrix.country }}"
              exit 0
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Attempt $i failed, retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
              fi
            fi
          done
          
          echo "âŒ Failed to sync ${{ matrix.country }} after $MAX_RETRIES attempts"
          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # Validation job runs after all country syncs complete
  validate:
    runs-on: ubuntu-latest
    needs: sync-country
    if: always() && needs.sync-country.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run validation tests
        run: npx tsx scripts/validate-data.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # Detect connections between ski areas
  sync-connections:
    runs-on: ubuntu-latest
    needs: validate
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (github.event_name == 'schedule' || inputs.skip_connections != true)
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Detect ski area connections
        run: |
          echo "ðŸ”— Detecting ski area connections..."
          npx tsx scripts/sync-connections.ts
          echo "âœ… Connection detection complete"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs: [sync-country, validate, sync-connections]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ¿ Ski Data Sync Results

          | Step | Status |
          |------|--------|
          | ðŸŽ¿ Country Sync | ${{ needs.sync-country.result == 'success' && 'âœ… Success' || (needs.sync-country.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Partial/Failed') }} |
          | âœ… Validation | ${{ needs.validate.result == 'success' && 'âœ… Passed' || (needs.validate.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |
          | ðŸ”— Connections | ${{ needs.sync-connections.result == 'success' && 'âœ… Success' || (needs.sync-connections.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |

          **Trigger:** ${{ github.event_name == 'schedule' && 'â° Scheduled (weekly)' || 'ðŸ”˜ Manual' }}
          EOF

