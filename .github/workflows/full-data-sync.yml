name: Full Data Sync Pipeline

on:
  # Run on the 1st of every month at midnight UTC
  schedule:
    - cron: '0 0 1 * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      skip_ski_areas:
        description: 'Skip syncing ski area data'
        type: boolean
        default: false
      skip_validation:
        description: 'Skip validation tests'
        type: boolean
        default: false

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  # ============================================================================
  # PHASE 0: Setup & Migration
  # ============================================================================
  setup:
    name: "ðŸ”§ Setup & Migrate"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      start_time: ${{ steps.timer.outputs.start_time }}
    
    steps:
      - name: Start Timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Apply database migrations
        run: |
          echo "ðŸ“¦ Applying database migrations..."
          npx prisma migrate deploy
          echo "âœ… Migrations complete"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # ============================================================================
  # PHASE 1: Sync Ski Areas (Highly Parallelized)
  # ============================================================================
  sync-europe-major:
    name: "ðŸ‡ªðŸ‡º Europe Major"
    needs: setup
    if: ${{ inputs.skip_ski_areas != true }}
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    strategy:
      matrix:
        country: [FR, CH, AT, IT]
      fail-fast: false
      max-parallel: 4
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      
      - name: "ðŸŽ¿ Sync ${{ matrix.country }}"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  SYNCING: ${{ matrix.country }}                                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "â–¶ Attempt $i of $MAX_RETRIES"
            if npx tsx scripts/sync-data.ts --country=${{ matrix.country }}; then
              echo "âœ… ${{ matrix.country }} complete"
              exit 0
            fi
            [ $i -lt $MAX_RETRIES ] && echo "â³ Waiting 60s..." && sleep 60
          done
          echo "âŒ Failed after $MAX_RETRIES attempts"
          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  sync-europe-other:
    name: "ðŸ‡ªðŸ‡º Europe Other"
    needs: setup
    if: ${{ inputs.skip_ski_areas != true }}
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    strategy:
      matrix:
        country: [DE, ES, AD, NO, SE, FI]
      fail-fast: false
      max-parallel: 6
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      
      - name: "ðŸŽ¿ Sync ${{ matrix.country }}"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  SYNCING: ${{ matrix.country }}                                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if npx tsx scripts/sync-data.ts --country=${{ matrix.country }}; then
              echo "âœ… ${{ matrix.country }} complete"
              exit 0
            fi
            [ $i -lt $MAX_RETRIES ] && sleep 60
          done
          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  sync-europe-east:
    name: "ðŸ‡ªðŸ‡º Europe East"
    needs: setup
    if: ${{ inputs.skip_ski_areas != true }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        country: [BG, RO, SI, SK, PL, CZ]
      fail-fast: false
      max-parallel: 6
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      
      - name: "ðŸŽ¿ Sync ${{ matrix.country }}"
        run: |
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if npx tsx scripts/sync-data.ts --country=${{ matrix.country }}; then
              echo "âœ… ${{ matrix.country }} complete"
              exit 0
            fi
            [ $i -lt $MAX_RETRIES ] && sleep 60
          done
          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  sync-americas:
    name: "ðŸŒŽ Americas"
    needs: setup
    if: ${{ inputs.skip_ski_areas != true }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    strategy:
      matrix:
        country: [US, CA]
      fail-fast: false
      max-parallel: 2
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      
      - name: "ðŸŽ¿ Sync ${{ matrix.country }}"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  SYNCING: ${{ matrix.country }} (Large dataset - may take a while)        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if npx tsx scripts/sync-data.ts --country=${{ matrix.country }}; then
              echo "âœ… ${{ matrix.country }} complete"
              exit 0
            fi
            [ $i -lt $MAX_RETRIES ] && sleep 120
          done
          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  sync-pacific:
    name: "ðŸŒ Pacific"
    needs: setup
    if: ${{ inputs.skip_ski_areas != true }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        country: [NZ, JP, AU]
      fail-fast: false
      max-parallel: 3
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      
      - name: "ðŸŽ¿ Sync ${{ matrix.country }}"
        run: |
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if npx tsx scripts/sync-data.ts --country=${{ matrix.country }}; then
              echo "âœ… ${{ matrix.country }} complete"
              exit 0
            fi
            [ $i -lt $MAX_RETRIES ] && sleep 60
          done
          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # ============================================================================
  # PHASE 2: Validation
  # ============================================================================
  validate:
    name: "âœ… Validate"
    needs: [setup, sync-europe-major, sync-europe-other, sync-europe-east, sync-americas, sync-pacific]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      inputs.skip_validation != true
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      
      - name: "âœ… Run Validation Tests"
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  VALIDATING DATA INTEGRITY                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          npx tsx scripts/validate-data.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: "ðŸ“Š Summary"
    needs: [setup, sync-europe-major, sync-europe-other, sync-europe-east, sync-americas, sync-pacific, validate]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Calculate Duration
        id: duration
        run: |
          START=${{ needs.setup.outputs.start_time }}
          END=$(date +%s)
          DURATION=$((END - START))
          MINS=$((DURATION / 60))
          SECS=$((DURATION % 60))
          echo "duration=${MINS}m ${SECS}s" >> $GITHUB_OUTPUT

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ¿ Full Data Sync Pipeline Results

          ## â±ï¸ Duration: ${{ steps.duration.outputs.duration }}

          ## Phase Results

          | Phase | Status |
          |-------|--------|
          | ðŸ”§ Setup & Migration | ${{ needs.setup.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |
          | ðŸ‡ªðŸ‡º Europe Major (FR/CH/AT/IT) | ${{ needs.sync-europe-major.result == 'success' && 'âœ… Success' || (needs.sync-europe-major.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Partial/Failed') }} |
          | ðŸ‡ªðŸ‡º Europe Other | ${{ needs.sync-europe-other.result == 'success' && 'âœ… Success' || (needs.sync-europe-other.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Partial/Failed') }} |
          | ðŸ‡ªðŸ‡º Europe East | ${{ needs.sync-europe-east.result == 'success' && 'âœ… Success' || (needs.sync-europe-east.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Partial/Failed') }} |
          | ðŸŒŽ Americas (US/CA) | ${{ needs.sync-americas.result == 'success' && 'âœ… Success' || (needs.sync-americas.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Partial/Failed') }} |
          | ðŸŒ Pacific (NZ/JP/AU) | ${{ needs.sync-pacific.result == 'success' && 'âœ… Success' || (needs.sync-pacific.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Partial/Failed') }} |
          | âœ… Validation | ${{ needs.validate.result == 'success' && 'âœ… Passed' || (needs.validate.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |

          ---

          **Completed:** ${{ github.event.repository.updated_at }}
          EOF

      - name: Check Overall Status
        if: |
          needs.setup.result == 'failure' ||
          needs.validate.result == 'failure'
        run: |
          echo "âŒ Pipeline had critical failures"
          exit 1
